<!DOCTYPE html>
<meta charset="utf-8">

<head>
   <link rel="stylesheet" type="text/css" href="css/foundation.min.css">
   <link rel="stylesheet" type="text/css" href="css/normalize.css">
   <script src="js/vendor/modernizr.js"></script>
   <script src="js/names.js"></script>
</head>

<body>
<nav class="top-bar" style="opacity:0.8;" data-topbar role="navigation">
  <ul class="title-area">
    <li class="name">
      <h1><a onclick="return false;" href="#">Light Curve Plots</a></h1>
    </li>
     <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
    <li class="toggle-topbar menu-icon"><a onclick="return false;" href="#"><span>Menu</span></a></li>
  </ul>

  <section class="top-bar-section">
    <!-- Left Nav Section -->
    <ul class="left">
      <li class="has-dropdown">
        <a onclick="return false;" href="#">Plot Type</a>
        <ul class="dropdown">
          <li class="active"><a id="sep" class="pltyp" href="#">Separate</a></li>
          <li><a id="rat" class="pltyp" href="#">Ratio</a></li>
          <li><a id="exc" class="pltyp" href="#">Excess</a></li>
          <li><a id="cum" class="pltyp" href="#">Cumulative Excess</a></li>
        </ul>
      </li>
      <li class="has-dropdown">
         <a onclick="return false;" class="has-form">
            <input class="sugbox" type="text" placeholder="Source 1"></input>
         </a>
         <ul class="dropdown">
            <li><a onclick="return false;" href="#">No Results</a></li>
         </ul>
      </li>
      <li class="has-dropdown">
         <a onclick="return false;" class="has-form">
            <input class="sugbox" type="text" placeholder="Source 2"></input>
         </a>
         <ul class="dropdown">
            <li><a onclick="return false;" href="#">No Results</a></li>
         </ul>
      </li>
      <li class="has-form">
         <input id="start" type="number" placeholder="Start Date (MJD)"></input>
      </li>
      <li class="has-form">
         <input id="end" type="number" placeholder="End Date (MJD)"></input>
      </li>
    </ul>

    <!-- Right Nav Section -->
    <ul class="right">
      <li class="active"><a id="ftchbtn" href="#">Fetch</a></li>
    </ul>
  </section>
</nav>
 
</body>
<script src="js/vendor/jquery.js"></script>
<script src="js/foundation/foundation.js"></script>
<script src="js/foundation/foundation.topbar.js"></script>

<script>
   $(document).foundation()

   // Given Gregorian calendar date d, returns mjd
   var get_mjd = function(d) {
      var year = d.getUTCFullYear();
      var month = d.getUTCMonth() + 1; // getMonth gives 0 for jan, want 1
      var day = d.getUTCDate();
      var hour = d.getUTCHours();
      var min = d.getUTCMinutes();
      var sec = d.getUTCSeconds(); // don't need this much precision, but why not?

      var a = Math.floor((14-month)/12);
      var y = year + 4800 - a;
      var m = month + 12*a - 3;

      // Using Gregorian calendar
      var jdn = day + Math.floor((153*m+2)/5) + 365*y + Math.floor(y/4);
      jdn += -Math.floor(y/100) + Math.floor(y/400) - 32045;

      var jd = jdn + (hour - 12)/24 + min/1440 + sec/86400;
      return jd - 2400000.5; // want mjd, not jd
   }
   
   // Initialize start & end dates in number boxes to last 24 hrs
   var end = Math.floor(100*get_mjd(new Date()))/100;
   $("#start").val(end-1);
   $("#end").val(end);
   

   // Populate source list & associative array
   var ascarr = {};
   sources.results.forEach(function(item) {
        ascarr[item.name] = item.id;
   });
   
   // Returns an array of suggestions from list based on txt
   function suggest(txt, list, n) {
      txt = txt.trim();
      // No input text
      if (txt == "")
         return ["No Results"];

      var arr = [];
      for (var i = 0; i < list.length; i++) {
         // Found n matches already
         if (n <= 0)
            break;
         
         // Add case insensitive matches to arr
         if (list[i].toLowerCase().indexOf(txt.toLowerCase()) > -1) {
            arr.push(list[i]);
            n--;
         }
      }
      
      // Didn't find any matches
      if (arr.length == 0)
         arr.push("No Results");
      
      return arr; 
   }
   
   // All functions requiring jquery go in here
   (function($) {
      // Pltyp Button's click handler
      $('.pltyp').on('click', function(e) {
         // Get DOM el'ts
         var par = $(this).parent();
         var gp = par.parent();
         var act = gp.find(".active");
         
         act.attr("class", "");
         par.attr("class","active");
         
         console.log($(this).attr('id'));
         // Return false so link isn't followed
         return false;
      });

      // Fetch Button's click handler
      $('#ftchbtn').on('click', function(e) {
         var bxls = $(document).find('.sugbox');
         for (var i = 0; i < bxls.length; i++) {
            var bx = $(bxls[i]);
            // Gets first match from source list
            var name = suggest(bx.val(), Object.keys(ascarr), 1)[0];
            // No source matches, so clear text box of nonsense
            if (name == "No Results"){
               bx.val("");
               continue;
            }
            
            // Explicitly set text box value to proper name
            bx.val(name);
         }
         // Return false so link isn't followed
         return false;
      });

      // Suggestion box input change handler
      $('.sugbox').on('input', function(e) {
         // Get DOM elements
         var par = $(this).parent().parent();
         var ul = par.find("ul");
         var txt = $(this).val();
         
         // Clear current list
         ul.children().remove();
         
         // Display 8 suggested source names based on input text
         var arr = suggest(txt, Object.keys(ascarr), 8);
         for (var i = 0; i < arr.length; i++)
            ul.append('<li><a href="#" class="suglnk">'+arr[i]+'</a></li>');
            
         // Suggestion link click handler
         $('.suglnk').on('click', function(e) {
            // Get DOM elt's
            var par = $(this).parent().parent().parent();
            var inp = par.find("input");
            var txt = $(this).text();
            
            // Check that we have an actual source
            if (txt == "No Results")
               return false;
            
            // Replace text box's value with link's text
            inp.val(txt);
            
            // Return false, so link isn't followed
            return false;
         });
      });
   }(jQuery));
</script>
